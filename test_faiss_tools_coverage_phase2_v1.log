/Users/nmhuyen/Documents/Manual Deploy/mpc_back_end_for_agents/setup/venv/lib/python3.10/site-packages/pytest_asyncio/plugin.py:217: PytestDeprecationWarning: The configuration option "asyncio_default_fixture_loop_scope" is unset.
The event loop scope for asynchronous fixtures will default to the fixture caching scope. Future versions of pytest-asyncio will default the loop scope for asynchronous fixtures to function scope. Set the default fixture loop scope explicitly in order to avoid unexpected behavior in the future. Valid fixture loop scopes are: "function", "class", "module", "package", "session"

  warnings.warn(PytestDeprecationWarning(_DEFAULT_FIXTURE_LOOP_SCOPE_UNSET))
============================= test session starts ==============================
platform darwin -- Python 3.10.17, pytest-8.3.5, pluggy-1.5.0 -- /Users/nmhuyen/Documents/Manual Deploy/mpc_back_end_for_agents/setup/venv/bin/python3.10
cachedir: .pytest_cache
rootdir: /Users/nmhuyen/Documents/Manual Deploy/mpc_back_end_for_agents
configfile: pytest.ini
plugins: anyio-4.9.0, asyncio-0.26.0, mock-3.14.0, cov-6.1.1
asyncio: mode=auto, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... 
----------------------------- live log collection ------------------------------
INFO     faiss.loader:loader.py:148 Loading faiss.
INFO     faiss.loader:loader.py:150 Successfully loaded faiss.
INFO     faiss:__init__.py:174 Failed to load GPU Faiss: name 'GpuIndexIVFFlat' is not defined. Will not load constructor refs for GPU indexes. This is only an error if you're trying to use GPU Faiss.
collected 15 items

ADK/agent_data/tests/tools/test_faiss_tools.py::TestSaveMetadataToFaiss::test_save_auto_embed 
-------------------------------- live log call ---------------------------------
INFO     ADK.agent_data.tools.register_tools:register_tools.py:5 sys.path in Cloud Run at top of register_tools.py: ['/Users/nmhuyen/Documents/Manual Deploy/mpc_back_end_for_agents', '/Users/nmhuyen/Documents/Manual Deploy/mpc_back_end_for_agents/ADK/agent_data/tests/tools', '/Users/nmhuyen/Documents/Manual Deploy/mpc_back_end_for_agents/setup/venv/bin', '/opt/homebrew/Cellar/python@3.10/3.10.17/Frameworks/Python.framework/Versions/3.10/lib/python310.zip', '/opt/homebrew/Cellar/python@3.10/3.10.17/Frameworks/Python.framework/Versions/3.10/lib/python3.10', '/opt/homebrew/Cellar/python@3.10/3.10.17/Frameworks/Python.framework/Versions/3.10/lib/python3.10/lib-dynload', '/Users/nmhuyen/Documents/Manual Deploy/mpc_back_end_for_agents/setup/venv/lib/python3.10/site-packages']
INFO     ADK.agent_data.tools.external_tool_registry:external_tool_registry.py:20 OpenAI import successful.
INFO     ADK.agent_data.tools.external_tool_registry:external_tool_registry.py:45 FAISS import successful.
INFO     ADK.agent_data.tools.external_tool_registry:external_tool_registry.py:73 OpenAI client initialized successfully via external registry.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:86 vector_data not provided for index 'test_index'. Attempting to generate embeddings.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:100 Generating embeddings for 2 documents using field 'text'. Expected dimension: 10.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:176 Successfully generated 2 embeddings from 2 documents (out of 2 originally).
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:179 Starting validation for index 'test_index' with 2 metadata entries and 2 vectors.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:208 vector_data is a list. Proceeding with list of vectors.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:276 Validation successful. All 2 processed vectors have dimension 10.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:281 Converting processed vector data to NumPy array.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:287 Creating FAISS index with actual dimension 10 from vector data.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:296 Number of vectors (2) is less than 20. Using IndexFlatL2.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:298 Created FAISS index (IndexFlatL2) with dimension 10.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:331 Adding 2 vectors to the index in batches.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:335 Adding batch 1/1 with 2 vectors to FAISS index (MagicMock)
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:337 Finished adding vectors. Index now contains <MagicMock name='IndexFlatL2().ntotal' id='4874776448'> vectors.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:339 Saving FAISS index locally to: /tmp/test_index.faiss
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:346 Saving metadata locally to: /tmp/test_index.meta
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:351 Attempting to save metadata to Firestore for index: test_index in project: test-project
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:373 Successfully saved metadata to Firestore for index: test_index
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:380 Attempting to save FAISS index and metadata to GCS Bucket: test-bucket
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:390 Uploading /tmp/test_index.faiss to gs://test-bucket/test_index.faiss
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:395 Uploading /tmp/test_index.meta to gs://test-bucket/test_index.meta
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:400 Successfully uploaded FAISS index and metadata for 'test_index' to GCS bucket 'test-bucket'.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:405 Registering FAISS index 'test_index' in Firestore collection 'faiss_indexes_registry'...
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:424 Successfully registered FAISS index 'test_index' in Firestore.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:440 Removed temporary local file: /tmp/test_index.meta
PASSED                                                                   [  6%]
ADK/agent_data/tests/tools/test_faiss_tools.py::TestSaveMetadataToFaiss::test_save_with_vector_data 
-------------------------------- live log call ---------------------------------
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:179 Starting validation for index 'test_index_vector' with 2 metadata entries and 2 vectors.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:187 vector_data is a dict. Extracting values as vectors.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:276 Validation successful. All 2 processed vectors have dimension 10.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:281 Converting processed vector data to NumPy array.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:287 Creating FAISS index with actual dimension 10 from vector data.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:296 Number of vectors (2) is less than 20. Using IndexFlatL2.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:298 Created FAISS index (IndexFlatL2) with dimension 10.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:331 Adding 2 vectors to the index in batches.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:335 Adding batch 1/1 with 2 vectors to FAISS index (MagicMock)
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:337 Finished adding vectors. Index now contains <MagicMock name='IndexFlatL2().ntotal' id='4875290608'> vectors.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:339 Saving FAISS index locally to: /tmp/test_index_vector.faiss
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:346 Saving metadata locally to: /tmp/test_index_vector.meta
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:351 Attempting to save metadata to Firestore for index: test_index_vector in project: test-project
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:373 Successfully saved metadata to Firestore for index: test_index_vector
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:380 Attempting to save FAISS index and metadata to GCS Bucket: test-bucket
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:390 Uploading /tmp/test_index_vector.faiss to gs://test-bucket/test_index_vector.faiss
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:395 Uploading /tmp/test_index_vector.meta to gs://test-bucket/test_index_vector.meta
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:400 Successfully uploaded FAISS index and metadata for 'test_index_vector' to GCS bucket 'test-bucket'.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:405 Registering FAISS index 'test_index_vector' in Firestore collection 'faiss_indexes_registry'...
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:424 Successfully registered FAISS index 'test_index_vector' in Firestore.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:440 Removed temporary local file: /tmp/test_index_vector.meta
PASSED                                                                   [ 13%]
ADK/agent_data/tests/tools/test_faiss_tools.py::TestSaveMetadataToFaiss::test_save_openai_embedding_error 
-------------------------------- live log call ---------------------------------
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:86 vector_data not provided for index 'test_openai_error_index'. Attempting to generate embeddings.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:100 Generating embeddings for 2 documents using field 'text'. Expected dimension: 10.
ERROR    ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:153 Failed to generate embedding for doc_id 'doc1' (embedding was None). Skipping.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:176 Successfully generated 1 embeddings from 1 documents (out of 2 originally).
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:179 Starting validation for index 'test_openai_error_index' with 1 metadata entries and 1 vectors.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:208 vector_data is a list. Proceeding with list of vectors.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:276 Validation successful. All 1 processed vectors have dimension 10.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:281 Converting processed vector data to NumPy array.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:287 Creating FAISS index with actual dimension 10 from vector data.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:296 Number of vectors (1) is less than 20. Using IndexFlatL2.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:298 Created FAISS index (IndexFlatL2) with dimension 10.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:331 Adding 1 vectors to the index in batches.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:335 Adding batch 1/1 with 1 vectors to FAISS index (MagicMock)
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:337 Finished adding vectors. Index now contains 1 vectors.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:339 Saving FAISS index locally to: /tmp/test_openai_error_index.faiss
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:346 Saving metadata locally to: /tmp/test_openai_error_index.meta
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:351 Attempting to save metadata to Firestore for index: test_openai_error_index in project: test-project
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:373 Successfully saved metadata to Firestore for index: test_openai_error_index
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:380 Attempting to save FAISS index and metadata to GCS Bucket: test-bucket
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:390 Uploading /tmp/test_openai_error_index.faiss to gs://test-bucket/test_openai_error_index.faiss
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:395 Uploading /tmp/test_openai_error_index.meta to gs://test-bucket/test_openai_error_index.meta
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:400 Successfully uploaded FAISS index and metadata for 'test_openai_error_index' to GCS bucket 'test-bucket'.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:405 Registering FAISS index 'test_openai_error_index' in Firestore collection 'faiss_indexes_registry'...
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:424 Successfully registered FAISS index 'test_openai_error_index' in Firestore.
INFO     ADK.agent_data.tools.save_metadata_to_faiss_tool:save_metadata_to_faiss_tool.py:440 Removed temporary local file: /tmp/test_openai_error_index.meta
PASSED                                                                   [ 20%]
ADK/agent_data/tests/tools/test_faiss_tools.py::TestSaveMetadataToFaiss::test_save_openai_api_error_during_embedding FAILED [ 26%]
ADK/agent_data/tests/tools/test_faiss_tools.py::TestLoadMetadataFromFaiss::test_load_completed 
-------------------------------- live log call ---------------------------------
INFO     ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:55 Checking Firestore status for index: test_load in collection 'faiss_indexes_registry'
INFO     ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:74 Firestore data for 'test_load': vectorStatus=completed, gcs_meta_path=gs://test-bucket/test_load.meta
INFO     ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:91 Firestore status check passed for index 'test_load'. Using gcs_meta_path: gs://test-bucket/test_load.meta
INFO     ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:110 Attempting GCS download using path from Firestore: gs://test-bucket/test_load.meta
INFO     ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:139 Loading metadata from: /tmp/test_load.meta
INFO     ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:148 Successfully loaded metadata for 'test_load'. Execution time: 0.9596s
PASSED                                                                   [ 33%]
ADK/agent_data/tests/tools/test_faiss_tools.py::TestLoadMetadataFromFaiss::test_load_pending 
-------------------------------- live log call ---------------------------------
INFO     ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:55 Checking Firestore status for index: test_pending in collection 'faiss_indexes_registry'
INFO     ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:74 Firestore data for 'test_pending': vectorStatus=pending, gcs_meta_path=None
WARNING  ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:77 Index 'test_pending' vectorStatus is 'pending', not 'completed'.
FAILED                                                                   [ 40%]
ADK/agent_data/tests/tools/test_faiss_tools.py::TestLoadMetadataFromFaiss::test_load_meta_unpickling_error 
-------------------------------- live log call ---------------------------------
INFO     ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:55 Checking Firestore status for index: test_unpickle_error in collection 'faiss_indexes_registry'
INFO     ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:74 Firestore data for 'test_unpickle_error': vectorStatus=completed, gcs_meta_path=gs://test-bucket/test_unpickle_error.meta
INFO     ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:91 Firestore status check passed for index 'test_unpickle_error'. Using gcs_meta_path: gs://test-bucket/test_unpickle_error.meta
INFO     ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:110 Attempting GCS download using path from Firestore: gs://test-bucket/test_unpickle_error.meta
INFO     ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:139 Loading metadata from: /tmp/test_unpickle_error.meta
ERROR    ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:165 General error in load_metadata_from_faiss for 'test_unpickle_error': Mocked Unpickling Error
Traceback (most recent call last):
  File "/Users/nmhuyen/Documents/Manual Deploy/mpc_back_end_for_agents/ADK/agent_data/tools/load_metadata_from_faiss_tool.py", line 141, in load_metadata_from_faiss
    loaded_data = pickle.load(f)
  File "/opt/homebrew/Cellar/python@3.10/3.10.17/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1114, in __call__
    return self._mock_call(*args, **kwargs)
  File "/opt/homebrew/Cellar/python@3.10/3.10.17/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1118, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
  File "/opt/homebrew/Cellar/python@3.10/3.10.17/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1173, in _execute_mock_call
    raise effect
_pickle.UnpicklingError: Mocked Unpickling Error
FAILED                                                                   [ 46%]
ADK/agent_data/tests/tools/test_faiss_tools.py::TestLoadMetadataFromFaiss::test_load_not_exists 
-------------------------------- live log call ---------------------------------
INFO     ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:55 Checking Firestore status for index: test_not_exists in collection 'faiss_indexes_registry'
WARNING  ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:63 Index 'test_not_exists' not found in Firestore registry.
PASSED                                                                   [ 53%]
ADK/agent_data/tests/tools/test_faiss_tools.py::TestQueryMetadataFaiss::test_query_success 
-------------------------------- live log call ---------------------------------
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:270 Executing query_metadata_faiss tool for index 'test_query', query_text (was key) 'find similar content to doc 0' (top_k=1).
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:277 Generating embedding for query text: 'find similar content to doc 0' directly.
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:292 Successfully generated embedding for query text 'find similar content to doc 0'. Vector length: 5
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:72 Checking Firestore status for index: test_query in collection 'faiss_indexes_registry' (Project: test-project, DB: test-db)
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:90 Firestore data for 'test_query': vectorStatus=completed, gcs_faiss_path=gs://test-bucket/test_query.faiss, gcs_meta_path=gs://test-bucket/test_query.meta
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:110 Firestore status check passed for index 'test_query'.
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:117 Local FAISS index file missing: /tmp/test_query.faiss. Attempting download from gs://test-bucket/test_query.faiss
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:126 Local metadata file missing: /tmp/test_query.meta. Attempting download from gs://test-bucket/test_query.meta
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:133 GCS download attempt finished for index 'test_query'. Files downloaded: {'index': True, 'meta': True}
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:136 Loading FAISS index for query: /tmp/test_query.faiss
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:139 Loaded FAISS index 'test_query' with dimension 5.
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:141 Loading metadata for query: /tmp/test_query.meta
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:148 Loaded 2 metadata entries and 2 stored IDs.
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:151 Validating query vector dimension (5) against index dimension (5).
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:159 Query vector validation successful.
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:163 Performing FAISS search for top 1 neighbors.
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:166 FAISS search completed. Found indices: [[0]], Distances: [[0.10000000149011612]]
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:198 Retrieved 1 metadata results for query.
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:217 query_metadata_faiss_internal finished for index 'test_query'. Status: success. Time: 0.6834s
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:331 FAISS query completed. Returning 1 neighbors' metadata for index 'test_query'.
PASSED                                                                   [ 60%]
ADK/agent_data/tests/tools/test_faiss_tools.py::TestQueryMetadataFaiss::test_query_pending 
-------------------------------- live log call ---------------------------------
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:270 Executing query_metadata_faiss tool for index 'test_query_pending', query_text (was key) 'q' (top_k=1).
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:277 Generating embedding for query text: 'q' directly.
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:292 Successfully generated embedding for query text 'q'. Vector length: 5
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:72 Checking Firestore status for index: test_query_pending in collection 'faiss_indexes_registry' (Project: test-project, DB: test-db)
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:90 Firestore data for 'test_query_pending': vectorStatus=pending, gcs_faiss_path=None, gcs_meta_path=None
WARNING  ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:93 Index 'test_query_pending' vectorStatus is 'pending', not 'completed'.
ERROR    ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:306 Internal FAISS query failed for index 'test_query_pending': Index 'test_query_pending' is not ready (vectorStatus: pending).
PASSED                                                                   [ 66%]
ADK/agent_data/tests/tools/test_faiss_tools.py::TestQueryMetadataFaiss::test_query_not_exists 
-------------------------------- live log call ---------------------------------
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:270 Executing query_metadata_faiss tool for index 'test_query_not_exists', query_text (was key) 'q' (top_k=1).
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:277 Generating embedding for query text: 'q' directly.
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:292 Successfully generated embedding for query text 'q'. Vector length: 5
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:72 Checking Firestore status for index: test_query_not_exists in collection 'faiss_indexes_registry' (Project: test-project, DB: test-db)
WARNING  ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:78 Index 'test_query_not_exists' not found in Firestore registry.
ERROR    ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:306 Internal FAISS query failed for index 'test_query_not_exists': Index 'test_query_not_exists' not found in Firestore registry.
PASSED                                                                   [ 73%]
ADK/agent_data/tests/tools/test_faiss_tools.py::TestQueryMetadataFaiss::test_query_firestore_error 
-------------------------------- live log call ---------------------------------
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:270 Executing query_metadata_faiss tool for index 'test_firestore_error_query', query_text (was key) 'some query' (top_k=1).
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:277 Generating embedding for query text: 'some query' directly.
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:292 Successfully generated embedding for query text 'some query'. Vector length: 5
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:72 Checking Firestore status for index: test_firestore_error_query in collection 'faiss_indexes_registry' (Project: test-project, DB: test-db)
ERROR    ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:245 General error during FAISS query internal for 'test_firestore_error_query': 503 Mocked Firestore Service Unavailable
Traceback (most recent call last):
  File "/Users/nmhuyen/Documents/Manual Deploy/mpc_back_end_for_agents/ADK/agent_data/tools/query_metadata_faiss_tool.py", line 75, in query_metadata_faiss_internal
    doc = doc_ref.get()
  File "/opt/homebrew/Cellar/python@3.10/3.10.17/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1114, in __call__
    return self._mock_call(*args, **kwargs)
  File "/opt/homebrew/Cellar/python@3.10/3.10.17/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1118, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
  File "/opt/homebrew/Cellar/python@3.10/3.10.17/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1173, in _execute_mock_call
    raise effect
google.api_core.exceptions.ServiceUnavailable: 503 Mocked Firestore Service Unavailable
ERROR    ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:306 Internal FAISS query failed for index 'test_firestore_error_query': Unexpected error during FAISS query: 503 Mocked Firestore Service Unavailable
PASSED                                                                   [ 80%]
ADK/agent_data/tests/tools/test_faiss_tools.py::TestQueryMetadataFaiss::test_query_gcs_download_error 
-------------------------------- live log call ---------------------------------
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:270 Executing query_metadata_faiss tool for index 'test_gcs_error_query', query_text (was key) 'another query' (top_k=1).
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:277 Generating embedding for query text: 'another query' directly.
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:292 Successfully generated embedding for query text 'another query'. Vector length: 5
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:72 Checking Firestore status for index: test_gcs_error_query in collection 'faiss_indexes_registry' (Project: test-project, DB: test-db)
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:90 Firestore data for 'test_gcs_error_query': vectorStatus=completed, gcs_faiss_path=gs://test-bucket/test_gcs_error.faiss, gcs_meta_path=gs://test-bucket/test_gcs_error.meta
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:110 Firestore status check passed for index 'test_gcs_error_query'.
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:117 Local FAISS index file missing: /tmp/test_gcs_error_query.faiss. Attempting download from gs://test-bucket/test_gcs_error.faiss
ERROR    ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:245 General error during FAISS query internal for 'test_gcs_error_query': 404 Mocked GCS File Not Found
Traceback (most recent call last):
  File "/Users/nmhuyen/Documents/Manual Deploy/mpc_back_end_for_agents/ADK/agent_data/tools/query_metadata_faiss_tool.py", line 119, in query_metadata_faiss_internal
    _download_gcs_file(storage_client, bucket_name, blob_name, local_index_path)
  File "/opt/homebrew/Cellar/python@3.10/3.10.17/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1114, in __call__
    return self._mock_call(*args, **kwargs)
  File "/opt/homebrew/Cellar/python@3.10/3.10.17/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1118, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
  File "/opt/homebrew/Cellar/python@3.10/3.10.17/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1173, in _execute_mock_call
    raise effect
google.api_core.exceptions.NotFound: 404 Mocked GCS File Not Found
ERROR    ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:306 Internal FAISS query failed for index 'test_gcs_error_query': Unexpected error during FAISS query: 404 Mocked GCS File Not Found
PASSED                                                                   [ 86%]
ADK/agent_data/tests/tools/test_faiss_tools.py::TestQueryMetadataFaiss::test_query_faiss_search_error 
-------------------------------- live log call ---------------------------------
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:270 Executing query_metadata_faiss tool for index 'test_faiss_search_error_query', query_text (was key) 'query text' (top_k=1).
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:277 Generating embedding for query text: 'query text' directly.
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:292 Successfully generated embedding for query text 'query text'. Vector length: 5
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:72 Checking Firestore status for index: test_faiss_search_error_query in collection 'faiss_indexes_registry' (Project: test-project, DB: test-db)
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:90 Firestore data for 'test_faiss_search_error_query': vectorStatus=completed, gcs_faiss_path=gs://test-bucket/test_faiss_search_error_query.faiss, gcs_meta_path=gs://test-bucket/test_faiss_search_error_query.meta
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:110 Firestore status check passed for index 'test_faiss_search_error_query'.
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:117 Local FAISS index file missing: /tmp/test_faiss_search_error_query.faiss. Attempting download from gs://test-bucket/test_faiss_search_error_query.faiss
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:126 Local metadata file missing: /tmp/test_faiss_search_error_query.meta. Attempting download from gs://test-bucket/test_faiss_search_error_query.meta
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:133 GCS download attempt finished for index 'test_faiss_search_error_query'. Files downloaded: {'index': True, 'meta': True}
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:136 Loading FAISS index for query: /tmp/test_faiss_search_error_query.faiss
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:139 Loaded FAISS index 'test_faiss_search_error_query' with dimension 5.
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:141 Loading metadata for query: /tmp/test_faiss_search_error_query.meta
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:148 Loaded 2 metadata entries and 2 stored IDs.
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:151 Validating query vector dimension (5) against index dimension (5).
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:159 Query vector validation successful.
INFO     ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:163 Performing FAISS search for top 1 neighbors.
ERROR    ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:168 RuntimeError during FAISS search for 'test_faiss_search_error_query': Mocked FAISS search error
Traceback (most recent call last):
  File "/Users/nmhuyen/Documents/Manual Deploy/mpc_back_end_for_agents/ADK/agent_data/tools/query_metadata_faiss_tool.py", line 165, in query_metadata_faiss_internal
    distances, indices = faiss_index.search(query_np, top_k)
  File "/opt/homebrew/Cellar/python@3.10/3.10.17/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1114, in __call__
    return self._mock_call(*args, **kwargs)
  File "/opt/homebrew/Cellar/python@3.10/3.10.17/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1118, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
  File "/opt/homebrew/Cellar/python@3.10/3.10.17/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1173, in _execute_mock_call
    raise effect
RuntimeError: Mocked FAISS search error
ERROR    ADK.agent_data.tools.query_metadata_faiss_tool:query_metadata_faiss_tool.py:306 Internal FAISS query failed for index 'test_faiss_search_error_query': FAISS search operation failed: Mocked FAISS search error
PASSED                                                                   [ 93%]
ADK/agent_data/tests/tools/test_faiss_tools.py::TestQueryMetadataFaiss::test_query_firestore_missing_gcs_faiss_path FAILED [100%]

=================================== FAILURES ===================================
_____ TestSaveMetadataToFaiss.test_save_openai_api_error_during_embedding ______

self = <test_faiss_tools.TestSaveMetadataToFaiss object at 0x1118b21d0>
mock_pickle_dump = <MagicMock name='dump' id='4876054256'>
mock_faiss_write_index = <MagicMock name='write_index' id='4876078480'>
MockFaissIndexFlatL2 = <MagicMock name='IndexFlatL2' id='4876086304'>
mock_get_embedding = <MagicMock name='get_openai_embedding' id='4876094192'>
mock_firestore_constructor = <MagicMock name='Client' id='4876102016'>
mock_upload_with_retry = <MagicMock name='upload_with_retry' id='4875721056'>
mock_storage_client = <MagicMock name='Client' id='4875729456'>
mock_firestore_client = (<MagicMock name='Client()' id='4875967776'>, <MagicMock name='Client().collection().document()' id='4876014576'>)
mocker = <pytest_mock.plugin.MockerFixture object at 0x12291a6e0>
request = <FixtureRequest for <Function test_save_openai_api_error_during_embedding>>

    @patch(f"{SAVE_TOOL_MODULE_PATH}.storage.Client")
    @patch(f"{SAVE_TOOL_MODULE_PATH}.upload_with_retry")
    @patch(FIRESTORE_CLIENT_PATH)
    @patch(f"{SAVE_TOOL_MODULE_PATH}.get_openai_embedding")
    @patch(f"{SAVE_TOOL_MODULE_PATH}.faiss.IndexFlatL2")
    @patch(f"{SAVE_TOOL_MODULE_PATH}.faiss.write_index")
    @patch(f"{SAVE_TOOL_MODULE_PATH}.pickle.dump")
    def test_save_openai_api_error_during_embedding(self, mock_pickle_dump, mock_faiss_write_index, MockFaissIndexFlatL2,
                                                    mock_get_embedding, mock_firestore_constructor, mock_upload_with_retry,
                                                    mock_storage_client, mock_firestore_client, mocker, request):
        from ADK.agent_data.tools.save_metadata_to_faiss_tool import save_metadata_to_faiss
    
        mock_firestore_constructor.return_value = mock_firestore_client[0]
        # Simulate openai.APIError on the first call to get_openai_embedding
        mock_get_embedding.side_effect = [
>           openai.APIError("Mocked API Error", http_status=500, request=None), # type: ignore
            np.array([0.2]*10, dtype=np.float32) # Subsequent call succeeds
        ]
E       TypeError: APIError.__init__() got an unexpected keyword argument 'http_status'

ADK/agent_data/tests/tools/test_faiss_tools.py:380: TypeError
_________________ TestLoadMetadataFromFaiss.test_load_pending __________________

self = <test_faiss_tools.TestLoadMetadataFromFaiss object at 0x1118b2b00>
mock_firestore_constructor = <MagicMock name='Client' id='4876751712'>
mock_firestore_client = (<MagicMock name='Client()' id='4876829072'>, <MagicMock name='Client().collection().document()' id='4876630048'>)

    @patch(FIRESTORE_CLIENT_PATH)
    def test_load_pending(self, mock_firestore_constructor, mock_firestore_client):
        from ADK.agent_data.tools.load_metadata_from_faiss_tool import load_metadata_from_faiss
    
        mock_firestore_constructor.return_value = mock_firestore_client[0]
        mock_doc_snapshot = MagicMock()
        mock_doc_snapshot.exists = True
        mock_doc_snapshot.to_dict.return_value = {
            "vectorStatus": "pending",
            "gcs_meta_path": None
        }
        mock_firestore_client[1].get.return_value = mock_doc_snapshot
    
        result = load_metadata_from_faiss(index_name="test_pending")
>       assert result.get("status") == "pending"
E       assert None == 'pending'
E        +  where None = <built-in method get of dict object at 0x122ac7fc0>('status')
E        +    where <built-in method get of dict object at 0x122ac7fc0> = {'error': "Index 'test_pending' is not ready (vectorStatus: pending).", 'meta': {'error_type': 'IndexNotReadyError', 'execution_time': 0.0003688335418701172, 'status': 'error'}}.get

ADK/agent_data/tests/tools/test_faiss_tools.py:480: AssertionError
------------------------------ Captured log call -------------------------------
INFO     ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:55 Checking Firestore status for index: test_pending in collection 'faiss_indexes_registry'
INFO     ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:74 Firestore data for 'test_pending': vectorStatus=pending, gcs_meta_path=None
WARNING  ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:77 Index 'test_pending' vectorStatus is 'pending', not 'completed'.
__________ TestLoadMetadataFromFaiss.test_load_meta_unpickling_error ___________

self = <test_faiss_tools.TestLoadMetadataFromFaiss object at 0x1118b1e10>
mock_builtin_open = <MagicMock name='open' id='4875463376'>
mock_pickle_load = <MagicMock name='load' id='4875778944'>
mock_firestore_constructor = <MagicMock name='Client' id='4875777648'>
mock_internal_download_gcs = <MagicMock name='_download_gcs_file' id='4875663632'>
mock_firestore_client = (<MagicMock name='Client()' id='4875616464'>, <MagicMock name='Client().collection().document()' id='4875492448'>)
mocker = <pytest_mock.plugin.MockerFixture object at 0x122aafe50>

    @patch(DOWNLOAD_GCS_LOAD_PATH)
    @patch(FIRESTORE_CLIENT_PATH)
    @patch(PICKLE_LOAD_LOAD_PATH)
    @patch(f"{LOAD_TOOL_MODULE_PATH}.open")
    def test_load_meta_unpickling_error(self, mock_builtin_open, mock_pickle_load, mock_firestore_constructor,
                                        mock_internal_download_gcs, mock_firestore_client, mocker):
        from ADK.agent_data.tools.load_metadata_from_faiss_tool import load_metadata_from_faiss
    
        mock_firestore_constructor.return_value = mock_firestore_client[0]
        mock_doc_snapshot = MagicMock()
        mock_doc_snapshot.exists = True
        mock_doc_snapshot.to_dict.return_value = {
            "vectorStatus": "completed",
            "gcs_meta_path": "gs://test-bucket/test_unpickle_error.meta"
        }
        mock_firestore_client[1].get.return_value = mock_doc_snapshot
    
        mock_internal_download_gcs.return_value = True # Simulate successful download
    
        # Configure open to return a mock file-like object
        mock_file = MagicMock(spec=io.BytesIO)
        mock_builtin_open.return_value.__enter__.return_value = mock_file
    
        # Simulate pickle.UnpicklingError
        mock_pickle_load.side_effect = pickle.UnpicklingError("Mocked Unpickling Error")
    
        result = load_metadata_from_faiss(index_name="test_unpickle_error")
        print(f"\nResult from test_load_meta_unpickling_error: {result}\n")
    
>       assert result.get("status") == "error"
E       assert None == 'error'
E        +  where None = <built-in method get of dict object at 0x122a3fc00>('status')
E        +    where <built-in method get of dict object at 0x122a3fc00> = {'error': "Unexpected error loading metadata for 'test_unpickle_error': Mocked Unpickling Error", 'meta': {'error_type': 'GeneralLoadError', 'execution_time': 0.69632887840271, 'file_downloaded': True, 'status': 'error'}}.get

ADK/agent_data/tests/tools/test_faiss_tools.py:512: AssertionError
----------------------------- Captured stdout call -----------------------------

Result from test_load_meta_unpickling_error: {'error': "Unexpected error loading metadata for 'test_unpickle_error': Mocked Unpickling Error", 'meta': {'status': 'error', 'execution_time': 0.69632887840271, 'file_downloaded': True, 'error_type': 'GeneralLoadError'}}

------------------------------ Captured log call -------------------------------
INFO     ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:55 Checking Firestore status for index: test_unpickle_error in collection 'faiss_indexes_registry'
INFO     ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:74 Firestore data for 'test_unpickle_error': vectorStatus=completed, gcs_meta_path=gs://test-bucket/test_unpickle_error.meta
INFO     ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:91 Firestore status check passed for index 'test_unpickle_error'. Using gcs_meta_path: gs://test-bucket/test_unpickle_error.meta
INFO     ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:110 Attempting GCS download using path from Firestore: gs://test-bucket/test_unpickle_error.meta
INFO     ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:139 Loading metadata from: /tmp/test_unpickle_error.meta
ERROR    ADK.agent_data.tools.load_metadata_from_faiss_tool:load_metadata_from_faiss_tool.py:165 General error in load_metadata_from_faiss for 'test_unpickle_error': Mocked Unpickling Error
Traceback (most recent call last):
  File "/Users/nmhuyen/Documents/Manual Deploy/mpc_back_end_for_agents/ADK/agent_data/tools/load_metadata_from_faiss_tool.py", line 141, in load_metadata_from_faiss
    loaded_data = pickle.load(f)
  File "/opt/homebrew/Cellar/python@3.10/3.10.17/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1114, in __call__
    return self._mock_call(*args, **kwargs)
  File "/opt/homebrew/Cellar/python@3.10/3.10.17/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1118, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
  File "/opt/homebrew/Cellar/python@3.10/3.10.17/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1173, in _execute_mock_call
    raise effect
_pickle.UnpicklingError: Mocked Unpickling Error
______ TestQueryMetadataFaiss.test_query_firestore_missing_gcs_faiss_path ______

self = <test_faiss_tools.TestQueryMetadataFaiss object at 0x1118cca90>
mock_get_embedding = <MagicMock name='get_openai_embedding' id='4878261008'>
mock_firestore_constructor = <MagicMock name='Client' id='4878268784'>
mock_firestore_client = (<MagicMock name='Client()' id='4877129696'>, <MagicMock name='Client().collection().document()' id='4876992176'>)
mocker = <pytest_mock.plugin.MockerFixture object at 0x122b7db10>

    @patch(FIRESTORE_CLIENT_PATH)
    @patch("ADK.agent_data.tools.query_metadata_faiss_tool.get_openai_embedding")
    async def test_query_firestore_missing_gcs_faiss_path(self, mock_get_embedding, mock_firestore_constructor, mock_firestore_client, mocker):
        from ADK.agent_data.tools.query_metadata_faiss_tool import query_metadata_faiss
    
        mock_agent_context = MagicMock()
        index_name_for_test = "test_missing_faiss_path"
    
        mock_firestore_constructor.return_value = mock_firestore_client[0]
        mock_doc_ref = mock_firestore_client[1]
    
        mock_doc_snapshot = MagicMock()
        mock_doc_snapshot.exists = True
        # Simulate Firestore document missing 'gcs_faiss_path'
        mock_doc_snapshot.to_dict.return_value = {
            "vectorStatus": "completed",
            "gcs_meta_path": f"gs://test-bucket/{index_name_for_test}.meta",
            "dimension": 5
        }
        mock_doc_ref.get.return_value = mock_doc_snapshot
    
        mock_get_embedding.return_value = [0.1]*5 # Dummy embedding
    
        tool_input = {
            "agent_context": mock_agent_context,
            "index_name": index_name_for_test,
            "query_text": "some query",
            "top_k": 1
        }
    
>       result = await query_metadata_faiss(**tool_input)
E       TypeError: query_metadata_faiss() got an unexpected keyword argument 'query_text'

ADK/agent_data/tests/tools/test_faiss_tools.py:922: TypeError
=============================== warnings summary ===============================
setup/venv/lib/python3.10/site-packages/faiss/loader.py:49
  /Users/nmhuyen/Documents/Manual Deploy/mpc_back_end_for_agents/setup/venv/lib/python3.10/site-packages/faiss/loader.py:49: DeprecationWarning: numpy.core._multiarray_umath is deprecated and has been renamed to numpy._core._multiarray_umath. The numpy._core namespace contains private NumPy internals and its use is discouraged, as NumPy internals can change without warning in any release. In practice, most real-world usage of numpy.core is to access functionality in the public NumPy API. If that is the case, use the public NumPy API. If not, you are using NumPy internals. If you would still like to access an internal attribute, use numpy._core._multiarray_umath.__cpu_features__.
    from numpy.core._multiarray_umath import __cpu_features__

<frozen importlib._bootstrap>:241
  <frozen importlib._bootstrap>:241: DeprecationWarning: builtin type SwigPyPacked has no __module__ attribute

<frozen importlib._bootstrap>:241
  <frozen importlib._bootstrap>:241: DeprecationWarning: builtin type SwigPyObject has no __module__ attribute

<frozen importlib._bootstrap>:241
  <frozen importlib._bootstrap>:241: DeprecationWarning: builtin type swigvarlink has no __module__ attribute

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
______________ coverage: platform darwin, python 3.10.17-final-0 _______________

Name                                                            Stmts   Miss  Cover   Missing
---------------------------------------------------------------------------------------------
ADK/agent_data/tools/__init__.py                                    1      0   100%
ADK/agent_data/tools/add_numbers_tool.py                           15     11    27%   17-30
ADK/agent_data/tools/advanced_query_faiss_tool.py                  58     49    16%   27-77, 82-91
ADK/agent_data/tools/advanced_semantic_search_tool.py              98     88    10%   10-25, 53-118, 124-152
ADK/agent_data/tools/aggregate_metadata_tool.py                    60     50    17%   26-73, 79-95
ADK/agent_data/tools/analyze_metadata_trends_tool.py               70     60    14%   28-85, 90-111
ADK/agent_data/tools/batch_generate_embeddings_tool.py             78     67    14%   28-94, 100-120
ADK/agent_data/tools/bulk_delete_metadata_tool.py                  93     82    12%   28-126, 132-153
ADK/agent_data/tools/bulk_update_metadata_tool.py                  76     67    12%   26-93, 99-124
ADK/agent_data/tools/clear_embeddings_tool.py                      54     54     0%   1-79
ADK/agent_data/tools/conditional_search_metadata_tool.py           11     10     9%   8-17
ADK/agent_data/tools/create_metadata_tree_tool.py                   3      2    33%   3-4
ADK/agent_data/tools/delay_tool.py                                 20     15    25%   16-37
ADK/agent_data/tools/delete_metadata_node_tool.py                   4      3    25%   3-5
ADK/agent_data/tools/depth_first_search_tool.py                     5      4    20%   3-7
ADK/agent_data/tools/detect_anomalies_tool.py                      65     53    18%   31-80, 86-109
ADK/agent_data/tools/echo_tool.py                                   7      4    43%   16-20
ADK/agent_data/tools/error_tool.py                                  7      5    29%   8, 12-15
ADK/agent_data/tools/external_tool_registry.py                    276    238    14%   23-38, 46-55, 74-81, 90-116, 131-217, 235-337, 351-411, 417-434
ADK/agent_data/tools/find_metadata_by_key_tool.py                   3      2    33%   3-4
ADK/agent_data/tools/generate_embedding_real_tool.py               62     62     0%   1-93
ADK/agent_data/tools/generate_embedding_tool.py                    67     56    16%   28-82, 87-109
ADK/agent_data/tools/get_registered_tools_tool.py                  15     11    27%   10-21
ADK/agent_data/tools/load_metadata_from_faiss_tool.py             104     39    62%   21, 24, 29-35, 85-86, 93-95, 120, 126-136, 155-158, 173-177, 190-201
ADK/agent_data/tools/metadata_statistics_tool.py                   63     52    17%   30-80, 92-109
ADK/agent_data/tools/multi_field_update_tool.py                    66     57    14%   27-87, 93-112
ADK/agent_data/tools/multi_update_metadata_tool.py                  7      6    14%   9-14
ADK/agent_data/tools/multiply_numbers_tool.py                      20     17    15%   15-37
ADK/agent_data/tools/query_metadata_faiss_tool.py                 223     80    64%   30, 33, 38-52, 101-106, 122, 131, 147, 153, 156, 158, 193-197, 207-208, 210-211, 213, 231-233, 238-240, 255-259, 261-265, 279-280, 288-290, 294-296, 313-315, 319-320, 335-337, 341-363
ADK/agent_data/tools/query_metadata_tool.py                         2      1    50%   3
ADK/agent_data/tools/rebuild_metadata_tree_from_faiss_tool.py      44     35    20%   25-59, 64-72
ADK/agent_data/tools/rebuild_metadata_tree_tool.py                  3      2    33%   5-6
ADK/agent_data/tools/register_tools.py                            104     44    58%   90-93, 99-116, 124-207
ADK/agent_data/tools/reverse_text_tool.py                          13     13     0%   1-25
ADK/agent_data/tools/save_document_tool.py                          9      6    33%   5-10
ADK/agent_data/tools/save_metadata_to_faiss_tool.py               416    244    41%   28, 38-40, 83, 88-89, 91-92, 94-95, 107-109, 113-115, 121-130, 142, 147, 155-157, 168-170, 181-182, 197-205, 211-213, 220-221, 228-234, 244-245, 251-252, 256-257, 263, 269-270, 273-274, 293, 300-329, 374-375, 382-383, 426-430, 436-437, 466-496, 500-504, 506-510, 515-536, 552, 556, 570-716
ADK/agent_data/tools/save_text_tool.py                             21     15    29%   22-40
ADK/agent_data/tools/semantic_expand_metadata_tool.py              46     37    20%   27-68, 73-80
ADK/agent_data/tools/semantic_filter_metadata_tool.py              65     55    15%   12-26, 45-84, 89-98
ADK/agent_data/tools/semantic_search_by_author_tool.py              3      2    33%   3-4
ADK/agent_data/tools/semantic_search_by_keyword_tool.py             3      2    33%   3-4
ADK/agent_data/tools/semantic_search_by_year_tool.py                3      2    33%   3-4
ADK/agent_data/tools/semantic_search_cosine_tool.py                69     69     0%   1-98
ADK/agent_data/tools/semantic_search_local_tool.py                  2      1    50%   3
ADK/agent_data/tools/semantic_search_metadata_tool.py               3      2    33%   3-4
ADK/agent_data/tools/semantic_search_metadata_tree_tool.py         60     50    17%   12-22, 40-77, 82-91
ADK/agent_data/tools/semantic_search_multiple_fields_tool.py       12     11     8%   9-20
ADK/agent_data/tools/semantic_similarity_search_tool.py            74     62    16%   31-88, 95-117
ADK/agent_data/tools/sort_metadata_tool.py                         60     51    15%   28-85, 91-107
ADK/agent_data/tools/update_metadata_node_tool.py                   4      3    25%   3-5
ADK/agent_data/tools/update_metadata_tool.py                        2      1    50%   3
ADK/agent_data/tools/validate_metadata_tree_tool.py                47     37    21%   29-65, 72-88
ADK/agent_data/tools/vectorize_document_tool.py                     2      1    50%   4
ADK/agent_data/tools/view_metadata_tree_tool.py                     2      1    50%   3
---------------------------------------------------------------------------------------------
TOTAL                                                            2700   1991    26%
Coverage XML written to file coverage.xml
=========================== short test summary info ============================
FAILED ADK/agent_data/tests/tools/test_faiss_tools.py::TestSaveMetadataToFaiss::test_save_openai_api_error_during_embedding
FAILED ADK/agent_data/tests/tools/test_faiss_tools.py::TestLoadMetadataFromFaiss::test_load_pending
FAILED ADK/agent_data/tests/tools/test_faiss_tools.py::TestLoadMetadataFromFaiss::test_load_meta_unpickling_error
FAILED ADK/agent_data/tests/tools/test_faiss_tools.py::TestQueryMetadataFaiss::test_query_firestore_missing_gcs_faiss_path
=================== 4 failed, 11 passed, 4 warnings in 6.53s ===================
