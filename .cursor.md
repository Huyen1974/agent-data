File Cung Cấp Thông Tin Hạ Tầng
Mục đích: Tài liệu này cung  cấp thông tin hạ tầng chi tiết cho Production (github-chatgpt-ggcloud) và Test (chat tablegpt-db-project), phục vụ triển khai Cloud Functions, Cloud Run, Workflows, và các dự án khác. Mọi thông số được xác nhận đến ngày 2025-03-06.

---
1. Thông tin chung
- Production:
  - Project ID: github-chatgpt-ggcloud
  - Project Number: 812872501910
  - Region: asia-southeast1
  - GitHub Repository: Huyen1974/chatgpt-githubnew
  - Branch: main
- Test:
  - Project ID: chatgpt-db-project
  - Project Number: 1042559846495
  - Region: asia-southeast1
 menopausal - GitHub Repository: Huyen1974/chatgpt-githubnew
  - Branch: test

---
2. Service Accounts
- Production:
  - Email: chatgpt-deployer@github-chatgpt-ggcloud.iam.gserviceaccount.com
  - IAM Roles: roles/run.invoker, roles/cloudfunctions.invoker, roles/pubsub.publisher, roles/secretmanager.secretAccessor, roles/storage.objectAdmin, roles/owner, roles/datastore.owner, roles/run.admin, roles/cloudfunctions.admin, roles/pubsub.admin, roles/cloudbuild.builds.builder, roles/workflows.editor, roles/workflows.invoker, roles/iam.serviceAccountTokenCreator, roles/iam.serviceAccountUser
- Test:
  - Email: gemini-service-account@chatgpt-db-project.iam.gserviceaccount.com
  - IAM Roles: roles/run.invoker, roles/cloudfunctions.invoker, roles/pubsub.publisher, roles/secretmanager.secretAccessor (trên cả chatgpt-db-project và github-chatgpt-ggcloud), roles/storage.objectAdmin, roles/cloudbuild.builds.builder, roles/workflows.editor, roles/workflows.invoker, roles/iam.serviceAccountTokenCreator, roles/iam.serviceAccountUser

---
3. Workload Identity Federation
- Production:
  - Pool ID: github-pool
  - Provider ID: github-provider
  - Full Name (Provider): projects/812872501910/locations/global/workloadIdentityPools/github-pool/providers/github-provider
- Test:
  - Pool ID: github-test-pool
  - Provider ID: github-test-provider
  - Full Name (Provider): projects/1042559846495/locations/global/workloadIdentityPools/github-test-pool/providers/github-test-provider

---
4. Buckets (Google Cloud Storage)
- Production:
  - Bucket Name: huyen1974-my-terraform-state
    - Mục đích: Terraform state
    - Region: asia-southeast1
    - Lifecycle Rules: -
  - Bucket Name: huyen1974-artifact-storage
    - Mục đích: Artifacts
    - Region: asia-southeast1
    - Lifecycle Rules: Delete sau 30 ngày
  - Bucket Name: huyen1974-chatgpt-functions
    - Mục đích: Functions/Containers
    - Region: asia-southeast1
    - Lifecycle Rules: Abort incomplete uploads sau 1 ngày
  - Bucket Name: huyen1974-log-storage
    - Mục đích: Logs
    - Region: asia-southeast1
    - Lifecycle Rules: -
- Test:
  - Bucket Name: huyen1974-my-terraform-test-state
    - Mục đích: Terraform state (test)
    - Region: asia-southeast1
    - Lifecycle Rules: -
  - Bucket Name: huyen1974-artifact-storage-test
    - Mục đích: Artifacts (test)
    - Region: asia-southeast1
    - Lifecycle Rules: Delete sau 30 ngày
  - Bucket Name: huyen1974-chatgpt-functions-test
    - Mục đích: Functions/Containers (test)
    - Region: asia-southeast1
    - Lifecycle Rules: Abort incomplete uploads sau 1 ngày
  - Bucket Name: huyen1974-log-storage-test
    - Mục đích: Logs (test)
    - Region: asia-southeast1
    - Lifecycle Rules: -
  - Bucket Name: gcf-v2-sources-1042559846495-asia-southeast1
    - Mục đích: Cloud Functions artifacts
    - Region: asia-southeast1
    - Lifecycle Rules: Delete versions cũ sau 3 bản

Có 2 bucket không thuộc quyền quản lý của Teraform cho dự án về lưu trữ thông tin backend, vectors bao gồm:
 Bucket bổ sung cho Faiss Index (Tạo thủ công)
- Production:
  - Bucket Name: huyen1974-faiss-index-storage
    - Mục đích: Lưu trữ file index Faiss (.bin)
    - Project: github-chatgpt-ggcloud
    - Region: asia-southeast1
    - Ngày tạo: 2025-04-08
    - Lifecycle Rules: Không có (lưu trữ lâu dài)
    - Ghi chú: Tạo thủ công bằng CLI, ngoài Terraform, để tránh xóa file sau 30 ngày như bucket artifacts hiện tại. Dùng để lưu file .bin khi triển khai function liên quan đến Faiss.
- Test:
  - Bucket Name: huyen1974-faiss-index-storage-test
    - Mục đích: Lưu trữ file index Faiss (.bin)
    - Project: chatgpt-db-project
    - Region: asia-southeast1
    - Ngày tạo: 2025-04-08
    - Lifecycle Rules: Không có (lưu trữ lâu dài)
    - Ghi chú: Tạo thủ công bằng CLI, ngoài Terraform, để tránh xóa file sau 30 ngày như bucket artifacts hiện tại. Dùng để lưu file .bin khi triển khai function liên quan đến Faiss.

---
5. Secrets (Google Secret Manager)
- Project: github-chatgpt-ggcloud (cả Production và Test dùng chung)
- Secrets:
  - chatgpt-deployer-key (asia-southeast1)
  - chatgpt-deployer-service-account-json (asia-southeast1)
  - github-token-sg (asia-southeast1)
  - lark-access-token-sg (asia-southeast1, cập nhật bởi generate-lark-token)
  - lark-app-secret-sg (asia-southeast1)
  - openai-api-key-sg (asia-southeast1)
- Quyền truy cập: Cả chatgpt-deployer và gemini-service-account có roles/secretmanager.secretAccessor

---
6. GitHub Secrets (Huyen1974/chatgpt-githubnew)
- Secret Name: GCP_WORKLOAD_IDENTITY_PROVIDER
  - Môi trường: Production
  - Giá trị: projects/812872501910/locations/global/workloadIdentityPools/github-pool/providers/github-provider
- Secret Name: GCP_SERVICE_ACCOUNT
  - Môi trường: Production
  - Giá trị: chatgpt-deployer@github-chatgpt-ggcloud.iam.gserviceaccount.com
- Secret Name: PROJECT_ID
  - Môi trường: Production
  - Giá trị: github-chatgpt-ggcloud
- Secret Name: GCP_WORKLOAD_IDENTITY_PROVIDER_TEST
  - Môi trường: Test
  - Giá trị: projects/1042559846495/locations/global/workloadIdentityPools/github-test-pool/providers/github-test-provider
- Secret Name: GCP_SERVICE_ACCOUNT_TEST
  - Môi trường: Test
  - Giá trị: gemini-service-account@chatgpt-db-project.iam.gserviceaccount.com
- Secret Name: PROJECT_ID_TEST
  - Môi trường: Test
  - Giá trị: chatgpt-db-project
- Secret Name: DOCKERHUB_USERNAME
  - Môi trường: Cả hai
  - Giá trị: nguyenminhhuyen (xác nhận từ bạn)
- Secret Name: DOCKERHUB_PASSWORD
  - Môi trường: Cả hai
  - Giá trị: Đã lưu (xác nhận từ bạn, hoạt động tốt trong CI/CD)
- Secret Name: GH_TOKEN
  - Môi trường: Cả hai
  - Giá trị: Đã lưu (scopes: read:org, repo, workflow, hoạt động tốt trong CI/CD)
- Ghi chú: Các giá trị nhạy cảm (DOCKERHUB_PASSWORD, GH_TOKEN) không cần hiển thị cụ thể, chỉ cần xác nhận chúng đã lưu và hoạt động là đủ

---
7. Docker Images
- Production:
  - Repository: asia-southeast1-docker.pkg.dev/github-chatgpt-ggcloud/docker-repo
  - Image mẫu: gcr.io/github-chatgpt-ggcloud/my-image:latest (Terraform khai báo, chưa kiểm tra thực tế)
- Test:
  - Repository: asia-southeast1-docker.pkg.dev/chatgpt-db-project/gcf-artifacts
  - Images:
    - chatgpt--db--project__asia--southeast1__dummy--function (2 phiên bản: ~3.4 MB, asia-southeast1, từ CI/CD 2025-03-05)
    - chatgpt--db--project__asia--southeast1__dummy--function/cache (~2.2 MB, asia-southeast1)
  - Dọn dẹp: gcr.io/chatgpt-db-project/dummy-function (ở us, đã xóa hết images, chỉ còn namespace rỗng)

---
8. Firestore
- Production:
  - Database Name: (default)
  - Region: asia-southeast1
  - Created: (Chưa kiểm tra)
  - Last Used: (Chưa kiểm tra)
- Test:
  - Database Name: test-default
  - Region: asia-southeast1
  - Created: 2025-03-04
  - Last Used: 2025-03-06

---
9. Cloud Functions
- Production:
  - Function Name: generate-lark-token
  - Region: asia-southeast1
  - Trigger: HTTP
  - Ghi chú: Cập nhật lark-access-token-sg
- Test:
  - Function Name: dummy-function
  - Region: asia-southeast1
  - Trigger: HTTP
  - Ghi chú: Từ CI/CD 2025-03-05, vẫn tồn tại

---
10. CI/CD (GitHub Actions)
- Production:
  - Trigger: Push nhánh main
  - Files Workflow: deploy_functions.yaml, deploy_containers.yaml, deploy_workflows.yaml
- Test:
  - Trigger: Push nhánh test hoặc workflow_dispatch
  - Files Workflow: deploy_functions.yaml, deploy_containers.yaml, deploy_workflows.yaml
- File mẫu (Test - deploy_functions.yaml):

name: Deploy to Google Cloud
on:
  push:
    branches: [ "test" ]
    paths: [ "functions/**", ".github/workflows/deploy_functions.yaml" ]
  workflow_dispatch:
jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER_TEST }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_TEST }}
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Deploy to Google Cloud Functions
        run: |
          set -e
          for FUNCTION_DIR in $(find functions -mindepth 1 -maxdepth 1 -type d); do
            FUNCTION_NAME=$(basename "$FUNCTION_DIR")
            echo "Deploying $FUNCTION_NAME..."
            ENTRY_POINT=$(grep -oP 'def \K\w+(?=\(.*\):)' "$FUNCTION_DIR/main.py" | head -n 1)
            if ! gcloud functions deploy "$FUNCTION_NAME" \
              --region=asia-southeast1 \
              --runtime=python310 \
              --trigger-http \
              --allow-unauthenticated \
              --source="$FUNCTION_DIR" \
              --entry-point="$ENTRY_POINT" \
              --project=${{ secrets.PROJECT_ID_TEST }}; then
              echo "❌ Deployment failed for $FUNCTION_NAME"
              exit 1
            fi
          done

---
11. APIs đã bật
- cloudfunctions.googleapis.com, pubsub.googleapis.com, firestore.googleapis.com, cloudbuild.googleapis.com, secretmanager.googleapis.com, run.googleapis.com, workflows.googleapis.com, iam.googleapis.com, artifactregistry.googleapis.com, storage.googleapis.com
